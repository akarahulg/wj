\documentclass[anyside]{tufte-book}

\geometry{
  textwidth=35pc,       % Increased from default 29pc
  marginparwidth=10pc,   % Decreased from default 10pc
  marginparsep=1em      % Adjust separation between text and margin note
}

% --- Packages ---
\usepackage{xcolor}
\usepackage{etoolbox}
\usepackage{hyperref}
\usepackage{amssymb}
\usepackage{calc} % Needed for width calculations in minipage
\usepackage{fontawesome5}
\usepackage{refcount} %%% To get the raw number from a reference
\usepackage{enumitem} % should already be loaded if you're customizing TOC
\usepackage{keyval}
\usepackage{fancyhdr}
\usepackage[normalem]{ulem} %%% For strikethrough text (\sout)

% --- Global Document Setup ---
\setcounter{tocdepth}{-1}

% --- Color Setup ---
\definecolor{TaskImp}{HTML}{D9534F}
\definecolor{TaskDone}{HTML}{428BCA}
\definecolor{SubTaskDone}{HTML}{407076}
\definecolor{TaskNote}{HTML}{5BC0DE}
\definecolor{TaskLabel}{HTML}{777777}
\definecolor{SubTask}{HTML}{333B3E}
\definecolor{TaskDefault}{HTML}{333B3E}
\definecolor{TaskActive}{HTML}{9A031E}
\definecolor{TaskBackground}{HTML}{EFEFEF}
\definecolor{IconColor}{HTML}{008B00}
\definecolor{MarkerColor}{HTML}{50723C}
\definecolor{ActiveTaskBackground}{HTML}{E8F5E9}
\definecolor{MeetingColor}{HTML}{6002EE}
\definecolor{MeetingBackground}{HTML}{F3E5F5}
\definecolor{MeetingHeld}{HTML}{388E3C}
\definecolor{MeetingCancelled}{HTML}{D32F2F}
\definecolor{MeetingUpcoming}{HTML}{F57C00}
\definecolor{TaskIgnore}{HTML}{999999} 
\definecolor{TagColor}{HTML}{D81E5B} 

\hypersetup{colorlinks=true, linkcolor=teal, urlcolor=cyan}

\newcommand{\mn}[1]{\marginnote{-- #1}}

% --- Quick Navigation ---
\newcommand{\quicknav}{%
  \noindent
  \textcolor{gray}{\footnotesize
    \hyperref[todolist]{\faList~\bf Todos} \quad
    \hyperref[activetasklist]{\faPlayCircle~\bf Active} \quad
    \hyperref[donetasklist]{\faCheckSquare~\bf Done} \quad
    \hyperref[ignoredtasklist]{\faTimesCircle~\bf Ignored} \quad
    \hyperref[meetinglist]{\faUsers~\bf Meetings}
  }\par
}

\fancyfoot[L]{\quicknav}
% --- Counters ---
\newcounter{tasknumber}
\newcounter{subtasknumber}[tasknumber]
\renewcommand{\thesubtasknumber}{\thetasknumber.\arabic{subtasknumber}}

\newcounter{counttodos}
\newcounter{countdone}
\newcounter{countactive}
\newcounter{countignored}
\newcounter{counttodosdo}
\newcounter{counttodosdecide}
\newcounter{counttodosdelegate}
\newcounter{counttodosdelete}
\newcounter{counttodosna}

\newcounter{meetingnumber}
\newcounter{countmeetings}
\newcounter{countmeetingsheld}
\newcounter{countmeetingsupcoming}
\newcounter{countmeetingscancelled}
\newcounter{countmeetingsna}


\makeatletter

% --- Task Status Commands (Done & Ignore) --- 
\newcommand{\@settaskdonestatus}[2]{%
  \csgdef{task@#1@isdone}{true}%
  \csgdef{task@#1@donedate}{#2}%
}
\newcommand{\@settaskignorestatus}[1]{%
  \csgdef{task@#1@isignored}{true}%
}


% --- \addcontentsline wrapper --- 
\let\original@addcontentsline\addcontentsline
\renewcommand{\addcontentsline}[3]{%
    \ifstrequal{#1}{tdo}{%
        \stepcounter{counttodos}%
        \edef\CurrentEisenCounterName{counttodos\TaskEisenValue}%
        \expandafter\addtocounter\expandafter{\CurrentEisenCounterName}{1}%
        \original@addcontentsline{tdo-\TaskEisenValue}{#2}{#3}%
    }{%
    \ifstrequal{#1}{mtg}{%
        \stepcounter{countmeetings}%
        \edef\CurrentMeetingCounterName{countmeetings\MeetingStatusValue}%
        \expandafter\addtocounter\expandafter{\CurrentMeetingCounterName}{1}%
        \original@addcontentsline{mtg-\MeetingStatusValue}{#2}{#3}%
    }{%
        \ifstrequal{#1}{act}{\stepcounter{countactive}}{}%
        \ifstrequal{#1}{odo}{\stepcounter{countdone}}{}%
        \ifstrequal{#1}{ign}{\stepcounter{countignored}}{}%
        \original@addcontentsline{#1}{#2}{#3}%
    }}%
}

% --- Daily Tasks Environment ---
\gdef\CurrentTaskPrefix{}
\gdef\CurrentDailyDate{} 

\newcommand{\dailytasks}[2]{%
  \bgroup
  \let\oldCurrentTaskPrefix\CurrentTaskPrefix
  \gdef\CurrentTaskPrefix{#1-}%
  \gdef\CurrentDailyDate{#1}% 
  \input{#2}%
  \gdef\CurrentDailyDate{}%
  \global\let\oldCurrentTaskPrefix\oldCurrentTaskPrefix
  \egroup
}

% --- Key-Value Setups ---
\newif\ifTaskIsDone \newif\ifTaskIsDoing \newif\ifTaskIsIgnored \newif\ifUserProvidedLabel \newif\ifUserProvidedDoneDate \newif\ifUserProvidedMarker \newif\ifUserProvidedTag
\def\ShortTaskLabel{} \def\TaskDoneDate{} \def\TaskMarker{} \def\taskcolor{} \def\TaskEisenValue{} \def\TaskTag{}
\define@key{task}{done}[true]{\TaskIsDonetrue}
\define@key{task}{doing}[true]{\TaskIsDoingtrue}
\define@key{task}{ignore}[true]{\TaskIsIgnoredtrue}
\define@key{task}{color}{\def\taskcolor{#1}}
\define@key{task}{label}{\def\ShortTaskLabel{#1}\UserProvidedLabeltrue}
\define@key{task}{donedate}{\def\TaskDoneDate{#1}\UserProvidedDoneDatetrue}
\define@key{task}{marker}{\def\TaskMarker{#1}\UserProvidedMarkertrue}
\define@key{task}{eisen}{\def\TaskEisenValue{#1}}
\define@key{task}{tag}{\def\TaskTag{#1}\UserProvidedTagtrue}

\newif\ifMeetingHasLabel \newif\ifMeetingHasDate \newif\ifMeetingHasTime \newif\ifMeetingHasLocation \newif\ifMeetingHasOrganizer \newif\ifMeetingHasAttendees
\def\MeetingLabel{} \def\MeetingDate{} \def\MeetingTime{} \def\MeetingLocation{} \def\MeetingOrganizer{} \def\MeetingAttendees{} \def\MeetingStatusValue{}
\define@key{meeting}{label}{\def\MeetingLabel{#1}\MeetingHasLabeltrue}
\define@key{meeting}{date}{\def\MeetingDate{#1}\MeetingHasDatetrue}
\define@key{meeting}{time}{\def\MeetingTime{#1}\MeetingHasTimetrue}
\define@key{meeting}{location}{\def\MeetingLocation{#1}\MeetingHasLocationtrue}
\define@key{meeting}{organizer}{\def\MeetingOrganizer{#1}\MeetingHasOrganizertrue}
\define@key{meeting}{attendees}{\def\MeetingAttendees{#1}\MeetingHasAttendeestrue}
\define@key{meeting}{status}{\def\MeetingStatusValue{#1}}


% --- Task Creation Internals ---
\newcommand{\@printtaskmarker}{%
    \ifUserProvidedMarker
        \textcolor{MarkerColor}{\texttt{\,~\TaskMarker~}}%
    \fi
}

%%% NEW: Helper command to print the tag if it exists
\newcommand{\@printtasktag}{%
    \ifUserProvidedTag
        \textcolor{magenta}{\texttt{\,\#\TaskTag}}%
    \fi
}

%%% MODIFIED: @createmaintask to display the tag
\newcommand{\@createmaintask}[4][]{%
    \bgroup
    \TaskIsDonefalse \TaskIsDoingfalse \TaskIsIgnoredfalse \UserProvidedLabelfalse \UserProvidedDoneDatefalse \UserProvidedMarkerfalse \UserProvidedTagfalse
    \def\ShortTaskLabel{} \def\TaskDoneDate{} \def\TaskMarker{} \def\TaskTag{}
    \def\TaskEisenValue{na}
    \def\taskcolor{#3}
    \setkeys{task}{#1}
    \refstepcounter{tasknumber}
    \def\labelForToc{}
    \ifUserProvidedLabel
        \xdef\FullTaskLabel{\CurrentTaskPrefix\ShortTaskLabel}%
        \ifcsdef{task@\FullTaskLabel @isignored}{%
            \TaskIsIgnoredtrue
        }{%
            \ifcsdef{task@\FullTaskLabel @isdone}{\TaskIsDonetrue \ifcsdef{task@\FullTaskLabel @donedate}{\edef\TaskDoneDate{\csuse{task@\FullTaskLabel @donedate}}\UserProvidedDoneDatetrue}{}}{}%
        }%
        \phantomsection\label{task:\FullTaskLabel}
        \expandafter\gdef\csname tasktext@\FullTaskLabel\endcsname{#4}
        \def\labelForToc{\protect\textcolor{TaskLabel}{\protect\texttt{\space[\FullTaskLabel]}}}
        \ifUserProvidedTag
            \protected@write\@auxout{}{\string\addtasktotag{\TaskTag}{\FullTaskLabel}}
        \fi
    \fi
    \def\markerForToc{}
    \ifUserProvidedMarker\def\markerForToc{\protect\textcolor{MarkerColor}{\protect\texttt{\protect\,~\TaskMarker~\protect}}\space}\fi
    
    \ifTaskIsDone
		\addcontentsline{odo}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space\markerForToc#4}
    \else\ifTaskIsIgnored
        \addcontentsline{ign}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space\markerForToc#4}
    \else
		\addcontentsline{#2}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space\markerForToc#4}
        \ifTaskIsDoing\addcontentsline{act}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space\markerForToc#4}\fi
    \fi\fi

    \par\noindent
    \ifTaskIsDone
        \ifUserProvidedDoneDate\marginnote{\textcolor{IconColor}{\faCalendarCheck}~\textcolor{magenta}{\bf \TaskDoneDate}}\fi
        \textcolor{IconColor}{\faCheck} ~\textcolor{TaskDone}{\textbf{Task \thetasknumber:}}%
        \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
        \@printtaskmarker\@printtasktag ~#4% %%% MODIFIED
    \else\ifTaskIsIgnored 
        \textcolor{IconColor}{\faTimes}~\textcolor{TaskIgnore}{\textbf{Task \thetasknumber:}}%
        \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
        \@printtaskmarker\@printtasktag ~\textcolor{TaskIgnore}{\sout{#4}}% %%% MODIFIED
    \else
        \ifTaskIsDoing
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                    \textcolor{IconColor}{\faPlayCircle}~\textcolor{TaskActive}{\textbf{Active ~\textcolor{TaskDefault}{Task \thetasknumber:}}}%
                    \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
                    \@printtaskmarker\@printtasktag \newline#4% %%% MODIFIED
                \end{minipage}%
            }%
        \else
            \colorbox{TaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                    \textcolor{IconColor}{\faDotCircle}~\textcolor{\taskcolor}{\textbf{Task \thetasknumber:}}%
                    \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
                    \@printtaskmarker\@printtasktag ~#4% %%% MODIFIED
                \end{minipage}%
            }%
        \fi
    \fi\fi
    \par\vspace{1mm}
    \egroup
}

%%% MODIFIED: @createsubtask to display the tag
\newcommand{\@createsubtask}[3][]{%
    \bgroup
    \TaskIsDonefalse \TaskIsDoingfalse \TaskIsIgnoredfalse \UserProvidedLabelfalse \UserProvidedDoneDatefalse \UserProvidedMarkerfalse \UserProvidedTagfalse
    \def\ShortTaskLabel{} \def\TaskDoneDate{} \def\TaskMarker{} \def\TaskTag{}
    \def\TaskEisenValue{na} \def\taskcolor{SubTask}
    \setkeys{task}{#1}
    \refstepcounter{subtasknumber}
    \def\labelForToc{}
    \ifUserProvidedLabel
        \xdef\FullTaskLabel{\CurrentTaskPrefix\ShortTaskLabel}%
        \ifcsdef{task@\FullTaskLabel @isignored}{%
            \TaskIsIgnoredtrue
        }{%
            \ifcsdef{task@\FullTaskLabel @isdone}{\TaskIsDonetrue \ifcsdef{task@\FullTaskLabel @donedate}{\edef\TaskDoneDate{\csuse{task@\FullTaskLabel @donedate}}\UserProvidedDoneDatetrue}{}}{}%
        }%
        \phantomsection \label{task:\FullTaskLabel}
        \expandafter\gdef\csname tasktext@\FullTaskLabel\endcsname{#3}
        \def\labelForToc{\protect\textcolor{TaskLabel}{\protect\texttt{\space[\FullTaskLabel]}}}
        \ifUserProvidedTag
            \protected@write\@auxout{}{\string\addtasktotag{\TaskTag}{\FullTaskLabel}}
        \fi
    \fi
    \def\markerForToc{}
    \ifUserProvidedMarker\def\markerForToc{\protect\textcolor{MarkerColor}{\protect\texttt{\protect\,~\TaskMarker~\protect}}\space}\fi

    \ifTaskIsDone
		\addcontentsline{odo}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space\markerForToc#3}
    \else\ifTaskIsIgnored
        \addcontentsline{ign}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space\markerForToc#3}
    \else
	    \addcontentsline{#2}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space\markerForToc#3}
        \ifTaskIsDoing\addcontentsline{act}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space\markerForToc#3}\fi
    \fi\fi

    \par\noindent\hspace{2em}%
    \ifTaskIsDone
        \ifUserProvidedDoneDate\marginnote{\textcolor{IconColor}{\faCalendarCheck}~\textcolor{magenta}{\bf \TaskDoneDate}}\fi
        \textcolor{IconColor}{\faCheck}~\textcolor{SubTaskDone}{\textbf{\thesubtasknumber:}}%
        \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
        \@printtaskmarker\@printtasktag ~#3% %%% MODIFIED
    \else\ifTaskIsIgnored 
        \textcolor{IconColor}{\faTimes}~\textcolor{TaskIgnore}{\textbf{\thesubtasknumber:}}%
        \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
        \@printtaskmarker\@printtasktag ~\textcolor{TaskIgnore}{\sout{#3}}% %%% MODIFIED
    \else
        \ifTaskIsDoing
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2em-2\fboxsep}
                    \textcolor{IconColor}{\faPlayCircle}~\textcolor{TaskActive}{\textbf{Active Task~ \textcolor{TaskDefault}{\thesubtasknumber}:}}%
                    \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
                    \@printtaskmarker\@printtasktag \newline#3% %%% MODIFIED
                \end{minipage}%
            }%
        \else
            \colorbox{TaskBackground}{%
                \begin{minipage}{\linewidth-2em-2\fboxsep}
                    \textcolor{IconColor}{\faDotCircle}~\textcolor{\taskcolor}{\textbf{\thesubtasknumber:}}%
                    \ifUserProvidedLabel\textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}\fi
                    \@printtaskmarker\@printtasktag ~#3% %%% MODIFIED
                \end{minipage}%
            }%
        \fi
    \fi\fi
    \par\vspace{1mm}
    \egroup
}

% --- Public Task Commands ---
\newcommand{\imp}[2][]{\@createmaintask[#1]{tdo}{TaskImp}{#2}}
\newcommand{\todo}[2][]{\@createmaintask[#1]{tdo}{TaskDefault}{#2}}
\newcommand{\subtodo}[2][]{\@createsubtask[#1]{tdo}{#2}}
\newcommand{\note}[1]{\textcolor{MarkerColor}{\faPen}~#1}
\newcommand{\thought}[1]{\textcolor{MarkerColor}{\faLightbulb}~#1}

% --- Meeting Command ---
% ... (No changes here, code omitted for brevity) ...
\newcommand{\meeting}[3][]{%
    \bgroup
    \MeetingHasLabelfalse \MeetingHasDatefalse \MeetingHasTimefalse \MeetingHasLocationfalse \MeetingHasOrganizerfalse \MeetingHasAttendeesfalse
    \def\MeetingLabel{} \def\MeetingDate{} \def\MeetingTime{} \def\MeetingLocation{} \def\MeetingOrganizer{} \def\MeetingAttendees{} \def\MeetingStatusValue{na}
    \setkeys{meeting}{#1}%
    \ifstrempty{\MeetingDate}{\def\MeetingDate{\textcolor{red}{\bf[No Date]}}}{}
    \ifstrempty{\MeetingTime}{\def\MeetingTime{\textcolor{red}{\bf[No Time]}}}{}
    \refstepcounter{meetingnumber}%
    \ifMeetingHasLabel\phantomsection\label{meeting:\MeetingLabel}\expandafter\gdef\csname meetingtitle@\MeetingLabel\endcsname{#2}\fi
    \def\statuscolor{MeetingColor}\def\statustext{}%
    \ifstrequal{\MeetingStatusValue}{held}{\def\statuscolor{MeetingHeld}\def\statustext{\textbf{[Held] }}}{}%
    \ifstrequal{\MeetingStatusValue}{upcoming}{\def\statuscolor{MeetingUpcoming}\def\statustext{\textbf{[Upcoming] }}}{}%
    \ifstrequal{\MeetingStatusValue}{cancelled}{\def\statuscolor{MeetingCancelled}\def\statustext{\textbf{[Cancelled] }}}{}%
    \addcontentsline{mtg}{section}{\protect\numberline{\bf\textcolor{magenta}{\themeetingnumber}}\ifMeetingHasLabel\protect\textcolor{TaskLabel}{\protect\texttt{\space[\MeetingLabel]}}\fi\space #2 (\MeetingDate)}
    \par\noindent
    \colorbox{MeetingBackground}{%
    \begin{minipage}{\linewidth-2\fboxsep}
        \textcolor{\statuscolor}{\faUsers}~%
        \textcolor{MeetingColor}{\textbf{Meeting \themeetingnumber:}}~%
        \textcolor{\statuscolor}{\statustext\textbf{#2}}%
        \ifMeetingHasLabel\textcolor{TaskLabel}{\texttt{\,[\MeetingLabel]}}\fi%
        \par\vspace{2mm}
        \hangindent=2.5em\noindent\textbf{Date:} \MeetingDate -- \MeetingTime\par
        \ifMeetingHasLocation\hangindent=2.5em\noindent\textbf{Location:} \MeetingLocation\par\fi
        \ifMeetingHasOrganizer\hangindent=2.5em\noindent\textbf{Organizer:} \MeetingOrganizer\par\fi
        \ifMeetingHasAttendees\hangindent=2.5em\noindent\textbf{Attendees:} \MeetingAttendees\par\fi
        \ifstrempty{#3}{}{\par\vspace{1.5mm}} 
        \let\oldCurrentTaskPrefix\CurrentTaskPrefix
        \ifMeetingHasLabel\gdef\CurrentTaskPrefix{\CurrentDailyDate-M-\MeetingLabel-}\else\gdef\CurrentTaskPrefix{\CurrentDailyDate-M\themeetingnumber-}\fi
        #3 % This is the meeting content
        \global\let\CurrentTaskPrefix\oldCurrentTaskPrefix
    \end{minipage}}%
    \par\vspace{2mm}
    \egroup
}

% --- Cross-referencing Commands ---
\newcommand{\reftask}[1]{%
  \ifcsdef{tasktext@#1}%
    {\hyperref[task:#1]{\textbf{Task~\getrefnumber{task:#1}:}~\csuse{tasktext@#1}}}% 
    {\textcolor{red}{[Unknown task '#1']}}%
}
\newcommand{\refmeeting}[1]{%
  \ifcsdef{meetingtitle@#1}%
    {\hyperref[meeting:#1]{\textbf{Meeting~\ref{meeting:#1}:}~\csuse{meetingtitle@#1}}}%
    {\textcolor{red}{[Unknown meeting '#1']}}%
}

% --- Tagging System Commands ---

\newcommand{\addtasktotag}[2]{% #1=tag name, #2=full task label
    \ifcsdef{taglist@#1}{}{%
        \csgdef{taglist@#1}{}%
    }%
    % Append '\item \reftask{...}' to the list for this tag
    \expandafter\g@addto@macro\csname taglist@#1\endcsname{\item \reftask{#2}}%
}
\newcommand{\showtag}[1]{%
    \bgroup 
	\subsection*{\bf Tag: \textcolor{TagColor}{#1}}
    \ifcsdef{taglist@#1}{%
        % Use an itemize environment to display the list of tasks
        \begin{itemize}[nosep, leftmargin=*] % Options from enumitem for compact list
            \csuse{taglist@#1}%
        \end{itemize}
    }{%
        \par\noindent\textit{No tasks found with this tag.}%
    }%
    \egroup
}


% --- Active Task Command --- 
% ... (No changes here, code omitted for brevity) ...
\newcommand{\activetask}[2][]{%
    \bgroup
    \TaskIsDonefalse\TaskIsIgnoredfalse \setkeys{task}{#1}%
    \ifcsdef{tasktext@#2}{%
        \ifTaskIsDone
            \ifx\CurrentDailyDate\empty \PackageWarning{MyTasks}{activetask[done] called outside a dailytasks environment. No date recorded.}\else\protected@write\@auxout{}{\string\@settaskdonestatus{\unexpanded{#2}}{\CurrentDailyDate}}\fi
            \par\noindent
            \textcolor{IconColor}{\faCalendarCheck}~%
            \hypersetup{linkcolor=TaskDone}%
            \hyperref[task:#2]{\textbf{Task \getrefnumber{task:#2}:}\textcolor{TaskLabel}{\texttt{\,[#2]}}~\textcolor{black}{\csuse{tasktext@#2}}}%
            \par\vspace{1mm}%
        \else\ifTaskIsIgnored 
            \protected@write\@auxout{}{\string\@settaskignorestatus{\unexpanded{#2}}}%
            \par\noindent
            \textcolor{IconColor}{\faTimes}~%
            \hypersetup{linkcolor=TaskIgnore}%
            \hyperref[task:#2]{\textcolor{TaskIgnore}{\textbf{Task \getrefnumber{task:#2}:}\textcolor{TaskLabel}{\texttt{\,[#2]}}~\sout{\csuse{tasktext@#2}}}}%
            \par\vspace{1mm}%
        \else
            \addcontentsline{act}{section}{\protect\numberline{\bf\textcolor{magenta}{\getrefnumber{task:#2}}}\protect\textcolor{TaskLabel}{\protect\texttt{\space[#2]}}\space \csuse{tasktext@#2}}%
            \par\noindent
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                    \textcolor{IconColor}{\faPlayCircle}~\textcolor{TaskActive}{\textbf{Active \ref{task:#2}:}}%
                    \textcolor{TaskLabel}{\texttt{\,[#2]}}\newline\csuse{tasktext@#2}%
                \end{minipage}%
            }%
            \par\vspace{1mm}%
        \fi\fi
    }{\par\noindent\textcolor{red}{[Unknown task label for \texttt{\textbackslash activetask}: '#2']}\par}%
    \egroup
}


% --- List of... Commands ---
% ... (No changes here, code omitted for brevity) ...
\newcommand{\listofactivetasks}{%
  \bgroup
  \renewcommand{\numberline}[1]{##1\quad}
  \renewcommand*\l@section[2]{\par\noindent\hangindent=3em\hangafter=1{##1\dotfill##2}\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}\hangindent=3em\hangafter=1{##1\dotfill##2}\par}
  \chapter{List of Active Tasks}\label{activetasklist}
  \par\noindent{\Large\textbf{Total active tasks: \textcolor{red}{\thecountactive}}}\par\vspace{1.5em}
  \@starttoc{act}
  \egroup
}
\newcommand{\listoftodos}{%
  \bgroup
  \renewcommand{\numberline}[1]{##1\quad}
  \renewcommand*\l@section[2]{\par\noindent\hangindent=3em\hangafter=1{##1\dotfill##2}\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}\hangindent=3em\hangafter=1{##1\dotfill##2}\par}
  \chapter{List of Todos}\label{todolist}
  \par\noindent{\Large\textbf{Total pending tasks: \textcolor{red}{\thecounttodos}}}\par\vspace{1.5em}
  \ifnum\value{counttodosdo}>0 \subsection*{\bf Do \normalfont\small\bf(Urgent \& Important) - \thecounttodosdo\ task(s)} \@starttoc{tdo-do} \vspace{1em} \fi
  \ifnum\value{counttodosdecide}>0 \subsection*{\bf Decide \normalfont\small\bf(Important, Not Urgent) - \thecounttodosdecide\ task(s)} \@starttoc{tdo-decide} \vspace{1em} \fi
  \ifnum\value{counttodosdelegate}>0 \subsection*{\bf Delegate \normalfont\small\bf(Urgent, Not Important) - \thecounttodosdelegate\ task(s)} \@starttoc{tdo-delegate} \vspace{1em} \fi
  \ifnum\value{counttodosdelete}>0 \subsection*{\bf Delete \normalfont\small\bf(Not Urgent, Not Important) - \thecounttodosdelete\ task(s)} \@starttoc{tdo-delete} \vspace{1em} \fi
  \ifnum\value{counttodosna}>0 \subsection*{\bf Others - \thecounttodosna\ task(s)} \@starttoc{tdo-na} \vspace{1em} \fi
  \egroup
}
\newcommand{\listofdonetodos}{%
  \bgroup
  \renewcommand{\numberline}[1]{##1\quad}
  \renewcommand*\l@section[2]{\par\noindent\hangindent=3em\hangafter=1\textcolor{TaskDone}{##1\dotfill##2}\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}\hangindent=3em\hangafter=1\textcolor{SubTaskDone}{##1\dotfill##2}\par}
  \chapter{List of Done Tasks}\label{donetasklist}
  \par\noindent{\Large\textbf{Total completed tasks: \textcolor{red}{\thecountdone}}}\par\vspace{1.5em}
  \@starttoc{odo}
  \egroup
}
\newcommand{\listofignoredtasks}{%
  \bgroup
  \renewcommand{\numberline}[1]{##1\quad}
  \renewcommand*\l@section[2]{\par\noindent\hangindent=3em\hangafter=1\textcolor{TaskIgnore}{##1\dotfill \sout{##2}}\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}\hangindent=3em\hangafter=1\textcolor{TaskIgnore}{##1\dotfill \sout{##2}}\par}
  \chapter{List of Ignored Tasks}\label{ignoredtasklist}
  \par\noindent{\Large\textbf{Total ignored tasks: \textcolor{red}{\thecountignored}}}\par\vspace{1.em}
  \@starttoc{ign}
  \egroup
}
\newcommand{\listofmeetings}{%
  \bgroup
  \renewcommand{\numberline}[1]{##1\quad}
  \renewcommand*\l@section[2]{\par\noindent\hangindent=3em\hangafter=1{##1\dotfill##2}\par}
  \chapter{List of Meetings}\label{meetinglist}
  \par\noindent{\Large\textbf{Total meetings logged: \textcolor{red}{\thecountmeetings}}}\par\vspace{1.5em}
  \ifnum\value{countmeetingsupcoming}>0 \subsection*{\bf \textcolor{MeetingUpcoming}{Upcoming} - \thecountmeetingsupcoming\ meeting(s)} \@starttoc{mtg-upcoming} \vspace{1em} \fi
  \ifnum\value{countmeetingsheld}>0 \subsection*{\bf \textcolor{MeetingHeld}{Held} - \thecountmeetingsheld\ meeting(s)} \@starttoc{mtg-held} \vspace{1em} \fi
  \ifnum\value{countmeetingscancelled}>0 \subsection*{\bf \textcolor{MeetingCancelled}{Cancelled} - \thecountmeetingscancelled\ meeting(s)} \@starttoc{mtg-cancelled} \vspace{1em} \fi
  \ifnum\value{countmeetingsna}>0 \subsection*{\bf Others - \thecountmeetingsna\ meeting(s)} \@starttoc{mtg-na} \vspace{1em} \fi
  \egroup
}

\makeatother

\begin{document}

\title{Work Journal}
\author{RG}

\let\cleardoublepage\clearpage

\input{entries.tex}

\listofactivetasks
\listoftodos
\listofmeetings
\listofignoredtasks
\listofdonetodos

\end{document}
