\documentclass[anyside]{tufte-book}

% --- Packages ---
\usepackage{xcolor}
\usepackage{etoolbox}
\usepackage{hyperref}
\usepackage{amssymb}
\usepackage{calc} % Needed for width calculations in minipage
\usepackage{fontawesome5}
\usepackage{refcount} %%% To get the raw number from a reference

% --- Global Document Setup ---
\setcounter{tocdepth}{-1}

% --- Color Setup ---
\definecolor{TaskImp}{HTML}{D9534F}
\definecolor{TaskDone}{HTML}{428BCA}
\definecolor{SubTaskDone}{HTML}{407076}
\definecolor{TaskNote}{HTML}{5BC0DE}
\definecolor{TaskLabel}{HTML}{777777}
\definecolor{SubTask}{HTML}{333B3E}
\definecolor{TaskBacklog}{HTML}{153131}
\definecolor{TaskDefault}{HTML}{333B3E}
\definecolor{TaskActive}{HTML}{9A031E}
\definecolor{TaskBackground}{HTML}{EFEFEF}
\definecolor{IconColor}{HTML}{008B00}
\definecolor{MarkerColor}{HTML}{50723C}
\definecolor{ActiveTaskBackground}{HTML}{E8F5E9}

\hypersetup{colorlinks=true, linkcolor=teal, urlcolor=cyan}


\newcommand{\mn}[1]{\marginnote{-- #1}}
% --- Counters ---
\newcounter{tasknumber}
\newcounter{subtasknumber}[tasknumber]
\renewcommand{\thesubtasknumber}{\thetasknumber.\arabic{subtasknumber}}

\newcounter{counttodos}
\newcounter{countbacklog}
\newcounter{countdone}
\newcounter{countactive}

\makeatletter

\let\original@addcontentsline\addcontentsline
\renewcommand{\addcontentsline}[3]{%
    \ifstrequal{#1}{tdo}{\stepcounter{counttodos}}{}%
    \ifstrequal{#1}{bkl}{\stepcounter{countbacklog}}{}%
    \ifstrequal{#1}{odo}{\stepcounter{countdone}}{}%
    \ifstrequal{#1}{act}{\stepcounter{countactive}}{}%
    \original@addcontentsline{#1}{#2}{#3}%
}


% --- Key-Value System and Prefix Management ---
\usepackage{keyval}
\gdef\CurrentTaskPrefix{}
\newcommand{\dailytasks}[2]{%
  \bgroup
  \let\oldCurrentTaskPrefix\CurrentTaskPrefix
  \gdef\CurrentTaskPrefix{#1-}%
  \input{#2}%
  \global\let\oldCurrentTaskPrefix\oldCurrentTaskPrefix
  \egroup
}

%%% REVISED: Added a new flag and key for the 'doing' state
\newif\ifTaskIsDone
\newif\ifTaskIsDoing %%% ADDED: New flag for 'doing' state
\newif\ifUserProvidedLabel
\newif\ifUserProvidedDoneDate
\newif\ifUserProvidedMarker
\def\ShortTaskLabel{}
\def\TaskDoneDate{}
\def\TaskMarker{}
\def\taskcolor{}
\define@key{task}{done}[true]{\TaskIsDonetrue}
\define@key{task}{doing}[true]{\TaskIsDoingtrue} %%% ADDED: New key for 'doing' state
\define@key{task}{color}{\def\taskcolor{#1}}
\define@key{task}{label}{\def\ShortTaskLabel{#1}\UserProvidedLabeltrue}
\define@key{task}{donedate}{\def\TaskDoneDate{#1}\UserProvidedDoneDatetrue}
\define@key{task}{marker}{\def\TaskMarker{#1}\UserProvidedMarkertrue}

% --- Internal Helper to Print the Marker ---
\newcommand{\@printtaskmarker}{%
    \ifUserProvidedMarker
        \textcolor{MarkerColor}{\texttt{\,~\TaskMarker~}}%
    \fi
}

% --- Master Task Creation Commands (Internal) ---

%%% REVISED: \@createmaintask now handles the 'doing' state
\newcommand{\@createmaintask}[4][]{%
    \bgroup
    % Reset flags for this task
    \TaskIsDonefalse
    \TaskIsDoingfalse %%% ADDED: Reset doing flag
    \UserProvidedLabelfalse
    \UserProvidedDoneDatefalse
    \UserProvidedMarkerfalse
    \def\ShortTaskLabel{}
    \def\TaskDoneDate{}
    \def\TaskMarker{}
    \def\taskcolor{#3}
    \setkeys{task}{#1}
    \refstepcounter{tasknumber}
    \def\labelForToc{}
    % --- Handle Labels and create the ToC entry text ---
    \ifUserProvidedLabel
        \xdef\FullTaskLabel{\CurrentTaskPrefix\ShortTaskLabel}%
        \phantomsection
        \label{task:\FullTaskLabel}
        \expandafter\gdef\csname tasktext@\FullTaskLabel\endcsname{#4}
        \def\labelForToc{\protect\textcolor{TaskLabel}{\protect\texttt{\space[\FullTaskLabel]}}}
    \fi

    % --- REVISED LIST LOGIC ---
    % Add the task to the appropriate list(s)
    \ifTaskIsDone
        % If done, it only goes to the 'done' list
		\addcontentsline{odo}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space #4}
    \else
        % If not done, it ALWAYS goes to its primary list (todo or backlog)
		\addcontentsline{#2}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space #4}
        % If it's ALSO being done, add it to the 'active' list as well
        \ifTaskIsDoing
            \addcontentsline{act}{section}{\protect\numberline{\bf\textcolor{magenta}{\thetasknumber}}\labelForToc\space #4}
        \fi
    \fi

    % --- REVISED PRINTING LOGIC (3 states: done, doing, pending) ---
    \par\noindent
    \ifTaskIsDone
        % --- State 1: DONE task ---
        \textcolor{IconColor}{\faCheck}
        ~\textcolor{TaskDone}{\textbf{\thetasknumber:}}%
        \ifUserProvidedDoneDate
            \textcolor{magenta}{\texttt{\,[DD:\TaskDoneDate]}}%
        \fi
        \ifUserProvidedLabel
            \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
        \fi
        \@printtaskmarker
		~#4%
    \else
        \ifTaskIsDoing
            % --- State 2: ACTIVE (DOING) task ---
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                \textcolor{IconColor}{\faPlayCircle}
				~\textcolor{TaskActive}{\textbf{Active Task~\textcolor{TaskDefault}{\thetasknumber:}}}%
                \ifUserProvidedLabel
                    \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
                \fi
                \@printtaskmarker
                ~#4%
                \end{minipage}%
            }%
        \else
            % --- State 3: PENDING (default) task ---
            \colorbox{TaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                \textcolor{IconColor}{\faGenderless}
                ~\textcolor{\taskcolor}{\textbf{\thetasknumber:}}%
                \ifUserProvidedLabel
                    \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
                \fi
                \@printtaskmarker
                ~#4%
                \end{minipage}%
            }%
        \fi
    \fi
    \par\vspace{1mm}
    \egroup
}

%%% REVISED: \@createsubtask now also handles the 'doing' state
\newcommand{\@createsubtask}[3][]{%
    \bgroup
    % Reset flags for this task
    \TaskIsDonefalse
    \TaskIsDoingfalse %%% ADDED: Reset doing flag
    \UserProvidedLabelfalse
    \UserProvidedDoneDatefalse
    \UserProvidedMarkerfalse
    \def\ShortTaskLabel{}
    \def\TaskDoneDate{}
    \def\TaskMarker{}
    \def\taskcolor{SubTask}
    \setkeys{task}{#1}
    \refstepcounter{subtasknumber}
    \def\labelForToc{}
    \ifUserProvidedLabel
        \xdef\FullTaskLabel{\CurrentTaskPrefix\ShortTaskLabel}%
        \phantomsection
        \label{task:\FullTaskLabel}
        \expandafter\gdef\csname tasktext@\FullTaskLabel\endcsname{#3}
        \def\labelForToc{\protect\textcolor{TaskLabel}{\protect\texttt{\space[\FullTaskLabel]}}}
    \fi

    % --- REVISED LIST LOGIC ---
    \ifTaskIsDone
		\addcontentsline{odo}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space #3}
    \else
	    \addcontentsline{#2}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space #3}
        \ifTaskIsDoing
            \addcontentsline{act}{subsection}{\protect\numberline{\bf\textcolor{magenta}{\thesubtasknumber}}\labelForToc\space #3}
        \fi
    \fi

    % --- REVISED SUBTASK PRINTING LOGIC (3 states) ---
    \par\noindent\hspace{2em}%
    \ifTaskIsDone
        % --- State 1: DONE subtask ---
        \textcolor{IconColor}{\faCheck}
        ~\textcolor{SubTaskDone}{\textbf{\thesubtasknumber:}}%
        \ifUserProvidedDoneDate
            \textcolor{magenta}{\texttt{\,[DD:\TaskDoneDate]}}%
        \fi
        \ifUserProvidedLabel
            \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
        \fi
        \@printtaskmarker
		~#3%
    \else
        \ifTaskIsDoing
            % --- State 2: ACTIVE (DOING) subtask ---
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2em-2\fboxsep}
                \textcolor{IconColor}{\faPlayCircle}
				~\textcolor{TaskActive}{\textbf{Active Task~ \textcolor{TaskDefault}{\thesubtasknumber}:}}%
                \ifUserProvidedLabel
                    \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
                \fi
                \@printtaskmarker
                ~#3%
                \end{minipage}%
            }%
        \else
            % --- State 3: PENDING subtask ---
            \colorbox{TaskBackground}{%
                \begin{minipage}{\linewidth-2em-2\fboxsep}
                \textcolor{IconColor}{\faGenderless}
                ~\textcolor{\taskcolor}{\textbf{\thesubtasknumber:}}%
                \ifUserProvidedLabel
                    \textcolor{TaskLabel}{\texttt{\,[\FullTaskLabel]}}%
                \fi
                \@printtaskmarker
                ~#3%
                \end{minipage}%
            }%
        \fi
    \fi
    \par\vspace{1mm}
    \egroup
}

% --- User-Facing Commands & Reference (Stable) ---
\newcommand{\imp}[2][]{\@createmaintask[#1]{tdo}{TaskImp}{#2}}
\newcommand{\todo}[2][]{\@createmaintask[#1]{tdo}{TaskDefault}{#2}}
\newcommand{\subtodo}[2][]{\@createsubtask[#1]{tdo}{#2}}
\newcommand{\backlog}[2][]{\@createmaintask[#1]{bkl}{TaskBacklog}{#2}}
\newcommand{\subbacklog}[2][]{\@createsubtask[#1]{bkl}{#2}}

\newcommand{\reftask}[1]{%
  \ifcsdef{tasktext@#1}%
    {\hyperref[task:#1]{\textbf{Task~\ref{task:#1}:}~\csuse{tasktext@#1}}}%
    {\textcolor{red}{[Unknown task label '#1']}}%
}

%%% NOTE: The \activetask command is now functionally superseded by the
%%%       [doing] option. For example, instead of:
%%%       \todo[label=mytask]{A task to do.}
%%%       ... later ...
%%%       \activetask{mytask}
%%%
%%%       You can now simply write:
%%%       \todo[doing, label=mytask]{A task to do.}
%%%
%%%       The old command is left here for compatibility but the new
%%%       workflow is recommended.
\newcommand{\activetask}[2][]{%
    \bgroup
    \TaskIsDonefalse
    \setkeys{task}{#1}%
    \ifcsdef{tasktext@#2}{%
        \ifTaskIsDone
            \par\noindent
            \textcolor{IconColor}{\faCheck}
            ~\textcolor{TaskDone}{\textbf{Task \ref{task:#2}:}}
            \textcolor{TaskLabel}{\texttt{\,[#2]}}%
            ~\csuse{tasktext@#2}%
            \par\vspace{1mm}
        \else
            \addcontentsline{act}{section}{%
                \protect\numberline{\bf\textcolor{magenta}{\getrefnumber{task:#2}}}%
                \protect\textcolor{TaskLabel}{\protect\texttt{\space[#2]}}%
                \space \csuse{tasktext@#2}%
            }%
            \par\noindent
            \colorbox{ActiveTaskBackground}{%
                \begin{minipage}{\linewidth-2\fboxsep}
                \textcolor{IconColor}{\faPlayCircle}
                ~\textcolor{TaskActive}{\textbf{Active Task \ref{task:#2}:}}%
                \textcolor{TaskLabel}{\texttt{\,[#2]}}%
                ~\csuse{tasktext@#2}%
                \end{minipage}%
            }%
            \par\vspace{1mm}
        \fi
    }{%
        \par\noindent\textcolor{red}{[Unknown task label for \texttt{\textbackslash activetask}: '#2']}\par
    }%
    \egroup
}


% --- "List of..." Commands ---
\newcommand{\listofactivetasks}{%
  \bgroup
  \renewcommand*\l@section[2]{\par\noindent##1\hfill##2\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}##1\hfill##2\par}
  \chapter{List of Active Tasks}
  \par\noindent{\Large\textbf{Total active tasks: \textcolor{red}{\thecountactive}}}\par\vspace{1.5em}
  \@starttoc{act}
  \egroup
}
\newcommand{\listoftodos}{%
  \bgroup
  \renewcommand*\l@section[2]{\par\noindent##1\hfill##2\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}##1\hfill##2\par}
  \chapter{List of Todos}
  \par\noindent{\Large\textbf{Total pending tasks: \textcolor{red}{\thecounttodos}}}\par\vspace{1.5em}
  \@starttoc{tdo}
  \egroup
}
\newcommand{\listofbacklog}{%
  \bgroup
  \renewcommand*\l@section[2]{\par\noindent##1\hfill##2\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}##1\hfill##2\par}
  \chapter{List of Backlog}
  \par\noindent{\Large\textbf{Total backlog tasks: \textcolor{red}{\thecountbacklog}}}\par\vspace{1.5em}
  \@starttoc{bkl}
  \egroup
}
\newcommand{\listofdonetodos}{%
  \bgroup
  \renewcommand*\l@section[2]{\par\noindent\textcolor{TaskDone}{##1\hfill##2}\par}
  \renewcommand*\l@subsection[2]{\par\noindent\hspace{2em}\textcolor{SubTaskDone}{##1\hfill##2}\par}
  \chapter{List of Done Tasks}
\par\noindent{\Large\textbf{Total completed tasks: \textcolor{red}{\thecountdone}}}\par\vspace{1.5em}
  \@starttoc{odo}
  \egroup
}
\makeatother

% --- Main Document ---
\begin{document}

\let\cleardoublepage\clearpage % Tufte-book specific tweak
\input{entries.tex}
\listofactivetasks
\listoftodos
\listofbacklog
\listofdonetodos

\end{document}
